
#user html;
worker_processes  2;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
#pid        logs/nginx.pid;

events {
	worker_connections  1024;
}


http {
	include       mime.types;
	default_type  application/octet-stream;

	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	client_max_body_size 15m;

	keepalive_timeout  65;

	# server {
	# 	listen 80;
	# 	listen 443 ssl;
	# 	server_name _;
	# 	return 444;
	# }

	server {
		listen 80;
		listen 443 ssl;
		server_name luarocks.org www.luarocks.org;

		# ssl_certificate /home/luarocks/sites/moonrocks-site/secret/www.luarocks.org.chained.crt;
		# ssl_certificate_key /home/luarocks/sites/moonrocks-site/secret/www.luarocks.org.key;

		ssl_certificate /etc/letsencrypt/live/luarocks.org/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/luarocks.org/privkey.pem;

		location / {
			root /home/luarocks/webroot;
			try_files $uri @moonrocks;
		}

		location @moonrocks {
			gzip on;
			gzip_types application/x-javascript text/css;

			proxy_pass http://127.0.0.1:8080;
			proxy_set_header Host $host;
			proxy_set_header X-Original-Scheme $scheme;
			proxy_set_header X-Forwarded-For $remote_addr;
		}
	}
	
	server {
		listen 80;
		listen 443 ssl;
		server_name *.luarocks.org;

		ssl_certificate /etc/letsencrypt/live/luarocks.org/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/luarocks.org/privkey.pem;

		location / {
			deny all;
			return 403;
		}
	}

	server {
		listen 80;
		listen 443 ssl;
		server_name rocks.moonscript.org;

		location / {
			gzip on;
			gzip_types application/x-javascript text/css;

			proxy_pass http://127.0.0.1:8080;
			proxy_set_header Host $host;
			proxy_set_header X-Original-Scheme $scheme;
			proxy_set_header X-Forwarded-For $remote_addr;
		}
	}

	server {
		listen 80;
		listen 443 ssl;
		server_name mirror.luarocks.org;

		ssl_certificate /etc/letsencrypt/live/luarocks.org/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/luarocks.org/privkey.pem;

		root /home/luarocks/backup/moonrocks_root_mirror;

		# Enable gzip for manifest files and text content
		gzip on;
		gzip_types text/plain application/json application/x-lua;
		gzip_min_length 1000;

		# File descriptor caching for large directories
		open_file_cache max=10000 inactive=60s;
		open_file_cache_valid 30s;
		open_file_cache_min_uses 2;
		open_file_cache_errors on;

		location / {
			autoindex on;
			autoindex_exact_size off;
			autoindex_localtime on;
		}
	}

}

