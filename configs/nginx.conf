
#user html;
worker_processes  2;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
#pid        logs/nginx.pid;

events {
	worker_connections  1024;
}


http {
	include       mime.types;
	default_type  application/octet-stream;

	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	client_max_body_size 15m;

	keepalive_timeout  65;

	# Hide nginx version
	server_tokens off;

	# SSL hardening
	ssl_protocols TLSv1.2 TLSv1.3;
	ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
	ssl_prefer_server_ciphers off;
	ssl_session_timeout 1d;
	ssl_session_cache shared:SSL:10m;
	ssl_session_tickets off;

	# OCSP Stapling
	ssl_stapling on;
	ssl_stapling_verify on;
	resolver 8.8.8.8 8.8.4.4 valid=300s;
	resolver_timeout 5s;

	# server {
	# 	listen 80;
	# 	listen 443 ssl;
	# 	server_name _;
	# 	return 444;
	# }

	server {
		listen 80;
		listen 443 ssl;
		server_name luarocks.org www.luarocks.org;

		# ssl_certificate /home/luarocks/sites/moonrocks-site/secret/www.luarocks.org.chained.crt;
		# ssl_certificate_key /home/luarocks/sites/moonrocks-site/secret/www.luarocks.org.key;

		ssl_certificate /etc/letsencrypt/live/luarocks.org/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/luarocks.org/privkey.pem;

		# HSTS (1 day initially, increase after confirming it works)
		add_header Strict-Transport-Security "max-age=86400; includeSubDomains" always;

		location / {
			root /home/luarocks/webroot;
			try_files $uri @moonrocks;
		}

		location @moonrocks {
			gzip on;
			gzip_types application/x-javascript text/css;

			proxy_pass http://127.0.0.1:8080;
			proxy_set_header Host $host;
			proxy_set_header X-Original-Scheme $scheme;
			proxy_set_header X-Forwarded-For $remote_addr;
		}
	}
	
	server {
		listen 80;
		listen 443 ssl;
		server_name *.luarocks.org;

		ssl_certificate /etc/letsencrypt/live/luarocks.org/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/luarocks.org/privkey.pem;

		location / {
			deny all;
			return 403;
		}
	}

	server {
		listen 80;
		listen 443 ssl;
		server_name rocks.moonscript.org;

		location / {
			gzip on;
			gzip_types application/x-javascript text/css;

			proxy_pass http://127.0.0.1:8080;
			proxy_set_header Host $host;
			proxy_set_header X-Original-Scheme $scheme;
			proxy_set_header X-Forwarded-For $remote_addr;
		}
	}

	server {
		listen 80;
		listen 443 ssl;
		server_name mirror.luarocks.org;

		ssl_certificate /etc/letsencrypt/live/luarocks.org/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/luarocks.org/privkey.pem;

		root /home/luarocks/backup/moonrocks_root_mirror;

		types {
			text/x-lua rockspec;
			application/zip rock;
			application/json json;
		}

		# Enable gzip for manifest files and text content
		gzip on;
		gzip_types text/plain application/json application/x-lua;
		gzip_min_length 1000;

		# File descriptor caching for large directories
		open_file_cache max=10000 inactive=60s;
		open_file_cache_valid 30s;
		open_file_cache_min_uses 2;
		open_file_cache_errors on;

		location / {
			add_header Cache-Control "public, s-maxage=3600, stale-while-revalidate=86400, stale-if-error=604800";
		}

		# Manifests change frequently, shorter cache
		# Matches /manifest, /manifest-5.1, /manifest-5.5.json, etc.
		location /manifest {
			default_type text/x-lua;
			add_header Cache-Control "public, s-maxage=60, stale-while-revalidate=300, stale-if-error=86400";
		}
	}

}

