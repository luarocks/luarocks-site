
#user html;
worker_processes  2;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
#pid        logs/nginx.pid;

events {
	worker_connections  1024;
}


http {
	include       mime.types;
	default_type  application/octet-stream;

	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	client_max_body_size 15m;

	keepalive_timeout  65;

	# Hide nginx version
	server_tokens off;

	# SSL hardening
	ssl_protocols TLSv1.2 TLSv1.3;
	ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
	ssl_prefer_server_ciphers off;
	ssl_session_timeout 1d;
	ssl_session_cache shared:SSL:10m;
	ssl_session_tickets off;

	# OCSP Stapling
	ssl_stapling on;
	ssl_stapling_verify on;
	resolver 8.8.8.8 8.8.4.4 valid=300s;
	resolver_timeout 5s;

	# Map to identify valid HTTP methods
	map $request_method $is_valid_method {
		GET     1;
		HEAD    1;
		POST    1;
		PUT     1;
		DELETE  1;
		OPTIONS 1;
		PATCH   1;
		default 0;
	}

	# Don't log requests with invalid methods
	map $is_valid_method $loggable {
		0 0;
		1 1;
	}

	access_log /var/log/nginx/access.log combined if=$loggable;


	# server {
	# 	listen 80;
	# 	listen 443 ssl;
	# 	server_name _;
	# 	return 444;
	# }

	server {
		listen 80;
		listen 443 ssl;
		server_name luarocks.org www.luarocks.org;

		# ssl_certificate /home/luarocks/sites/moonrocks-site/secret/www.luarocks.org.chained.crt;
		# ssl_certificate_key /home/luarocks/sites/moonrocks-site/secret/www.luarocks.org.key;

		ssl_certificate /etc/letsencrypt/live/luarocks.org/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/luarocks.org/privkey.pem;

		# HSTS (1 day initially, increase after confirming it works)
		add_header Strict-Transport-Security "max-age=86400; includeSubDomains" always;

		# Drop requests with invalid HTTP methods
		if ($is_valid_method = 0) {
			return 444;
		}

		location / {
			root /home/luarocks/webroot;
			try_files $uri @moonrocks;
		}

		location @moonrocks {
			gzip on;
			gzip_types application/x-javascript text/css;

			proxy_pass http://127.0.0.1:8080;
			proxy_set_header Host $host;
			proxy_set_header X-Original-Scheme $scheme;
			proxy_set_header X-Forwarded-For $remote_addr;
		}
	}
	
	server {
		listen 80;
		listen 443 ssl;
		server_name *.luarocks.org;

		ssl_certificate /etc/letsencrypt/live/luarocks.org/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/luarocks.org/privkey.pem;

		# Drop requests with invalid HTTP methods
		if ($is_valid_method = 0) {
			return 444;
		}

		location / {
			deny all;
			return 403;
		}
	}

	server {
		listen 80;
		listen 443 ssl;
		server_name rocks.moonscript.org;

		# Drop requests with invalid HTTP methods
		if ($is_valid_method = 0) {
			return 444;
		}

		location / {
			gzip on;
			gzip_types application/x-javascript text/css;

			proxy_pass http://127.0.0.1:8080;
			proxy_set_header Host $host;
			proxy_set_header X-Original-Scheme $scheme;
			proxy_set_header X-Forwarded-For $remote_addr;
		}
	}

	server {
		listen 80;
		listen 443 ssl;
		server_name mirror.luarocks.org;

		ssl_certificate /etc/letsencrypt/live/luarocks.org/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/luarocks.org/privkey.pem;

		# Drop requests with invalid HTTP methods
		if ($is_valid_method = 0) {
			return 444;
		}

		root /home/luarocks/backup/moonrocks_root_mirror;

		types {
			text/html html;
			text/x-lua rockspec;
			application/zip rock;
			application/json json;
		}

		# Enable gzip for manifest files and text content
		gzip on;
		gzip_types text/plain application/json application/x-lua;
		gzip_min_length 1000;

		# File descriptor caching for large directories
		open_file_cache max=10000 inactive=60s;
		open_file_cache_valid 30s;
		open_file_cache_min_uses 2;
		open_file_cache_errors on;

		location / {
			add_header Cache-Control "public, s-maxage=3600, stale-while-revalidate=86400, stale-if-error=604800";
		}

		# Manifests change frequently, shorter cache
		# Matches /manifest, /manifest-5.1, /manifest-5.5.json, etc.
		location /manifest {
			default_type text/x-lua;
			add_header Cache-Control "public, s-maxage=60, stale-while-revalidate=300, stale-if-error=86400";
		}
	}

  # Cloudflare proxy IP ranges
  # This will set remote_addr to be the actual visitors IP address when being proxied through cloudflare
  # Keep in sync with https://www.cloudflare.com/ips/
  real_ip_header CF-Connecting-IP;
  real_ip_recursive on;

  # IPv4
  set_real_ip_from 173.245.48.0/20;
  set_real_ip_from 103.21.244.0/22;
  set_real_ip_from 103.22.200.0/22;
  set_real_ip_from 103.31.4.0/22;
  set_real_ip_from 141.101.64.0/18;
  set_real_ip_from 108.162.192.0/18;
  set_real_ip_from 190.93.240.0/20;
  set_real_ip_from 188.114.96.0/20;
  set_real_ip_from 197.234.240.0/22;
  set_real_ip_from 198.41.128.0/17;
  set_real_ip_from 162.158.0.0/15;
  set_real_ip_from 104.16.0.0/13;
  set_real_ip_from 104.24.0.0/14;
  set_real_ip_from 172.64.0.0/13;
  set_real_ip_from 131.0.72.0/22;

  # IPv6
  set_real_ip_from 2400:cb00::/32;
  set_real_ip_from 2606:4700::/32;
  set_real_ip_from 2803:f800::/32;
  set_real_ip_from 2405:b500::/32;
  set_real_ip_from 2405:8100::/32;
  set_real_ip_from 2a06:98c0::/29;
  set_real_ip_from 2c0f:f248::/32;
}

